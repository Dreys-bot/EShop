<!DOCTYPE html>  <html> <head>   <title>jwa.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="jot.html">                 jot.coffee               </a>                                           <a class="source" href="jwa.html">                 jwa.coffee               </a>                                           <a class="source" href="jwk.html">                 jwk.coffee               </a>                                           <a class="source" href="jwt.html">                 jwt.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               jwa.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Node</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">crypto  = </span><span class="nx">require</span> <span class="s">&quot;crypto&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Lib</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ju      = </span><span class="nx">require</span> <span class="s">&quot;./utils&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The following is based on <a href="https://www.ietf.org/id/draft-ietf-jose-json-web-algorithms-02.txt">JSON Web Algorithms (JWA) v02</a>:</p>

<p>The JSON Web Algorithms (JWA) specification enumerates cryptographic algorithms and identifiers to be used with the 
JSON Web Signature (JWS) [JWS] and JSON Web Encryption (JWE) [JWE] specifications.  Enumerating the algorithms and
identifiers for them in this specification, rather than in the JWS and JWE specifications, is intended to allow them
to remain unchanged in the face of changes in the set of required, recommended, optional, and deprecated algorithms
over time. This specification also describes the semantics and operations that are specific to these algorithms and 
algorithm families.</p>

<p>+--------------------+----------------------------------------------+
  | alg Parameter      | Digital Signature or MAC Algorithm           |
  | Value              |                                              |
  +--------------------+----------------------------------------------+
  | HS256              | HMAC using SHA-256 hash algorithm            |
  | HS384              | HMAC using SHA-384 hash algorithm            |
  | HS512              | HMAC using SHA-512 hash algorithm            |
  | RS256              | RSA using SHA-256 hash algorithm             |
  | RS384              | RSA using SHA-384 hash algorithm             |
  | RS512              | RSA using SHA-512 hash algorithm             |
  | ES256              | ECDSA using P-256 curve and SHA-256 hash     |
  |                    | algorithm                                    |
  | ES384              | ECDSA using P-384 curve and SHA-384 hash     |
  |                    | algorithm                                    |
  | ES512              | ECDSA using P-521 curve and SHA-512 hash     |
  |                    | algorithm                                    |
  | none               | No digital signature or MAC value included   |
  +--------------------+----------------------------------------------+</p>

<p>Of these algorithms, only HMAC SHA-256 and "none" MUST be implemented by conforming JWS implementations. 
 It is RECOMMENDED that implementations also support the RSA SHA-256 and ECDSA P-256 SHA-256 algorithms. <br />
 Support for other algorithms and key sizes is OPTIONAL.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">jwa_table =</span>
  <span class="nv">NONE :</span>
    <span class="nv">TYPE : </span><span class="s">&quot;SIGNATURE&quot;</span>
    <span class="nv">HASH_AL : </span><span class="p">{}</span>
  <span class="nv">HMAC :</span>
    <span class="nv">TYPE    : </span><span class="s">&quot;SIGNATURE&quot;</span>
    <span class="nv">HASH_AL :</span>
      <span class="nv">HS256 : </span><span class="s">&quot;SHA256&quot;</span>
      <span class="nv">HS384 : </span><span class="s">&quot;SHA384&quot;</span>
      <span class="nv">HS512 : </span><span class="s">&quot;SHA512&quot;</span>
  <span class="nv">RSA :</span>
    <span class="nv">TYPE    : </span><span class="s">&quot;SIGNATURE&quot;</span>
    <span class="nv">HASH_AL :</span>
      <span class="nv">RS256 : </span><span class="s">&quot;RSA-SHA256&quot;</span>
      <span class="nv">RS384 : </span><span class="s">&quot;RSA-SHA384&quot;</span>
      <span class="nv">RS512 : </span><span class="s">&quot;RSA-SHA512&quot;</span>


<span class="k">class</span> <span class="nx">JwaAlgorithm</span>

  <span class="nv">type : </span><span class="nf">() -&gt;</span>
    <span class="nx">jwa_table</span><span class="o">?</span><span class="p">[</span><span class="nx">@alg</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">TYPE</span>

  <span class="nv">hash : </span><span class="nf">(alg) -&gt;</span>
    <span class="nx">jwa_table</span><span class="o">?</span><span class="p">[</span><span class="nx">@alg</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">HASH_AL</span><span class="p">[</span><span class="nx">alg</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>To support use cases where the content is secured by a means other than a digital signature or MAC value, JWSs MAY also be created
without them.  These are called "Plaintext JWSs".  Plaintext JWSs MUST use the "alg" value "none", and are formatted identically to
other JWSs, but with an empty JWS Signature value.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">NoneSigner</span> <span class="k">extends</span> <span class="nx">JwaAlgorithm</span>

  <span class="nv">alg : </span><span class="s">&quot;NONE&quot;</span>

  <span class="nv">update: </span><span class="nf">(data) -&gt;</span>
    <span class="nx">@</span>

  <span class="nv">digest: </span><span class="nf">() -&gt;</span> <span class="s">&quot;&quot;</span>

  <span class="nv">sign: </span><span class="nf">() -&gt;</span> <span class="nx">@digest</span><span class="p">()</span>


<span class="nv">NONE_SIGNER = </span><span class="k">new</span> <span class="nx">NoneSigner</span>

<span class="nv">newNoneSigner = </span><span class="nf">( ) -&gt;</span> <span class="nx">NONE_SIGNER</span>

<span class="k">class</span> <span class="nx">NoneVerifier</span> <span class="k">extends</span> <span class="nx">JwaAlgorithm</span>

  <span class="nv">alg : </span><span class="s">&quot;NONE&quot;</span>

  <span class="nv">verify: </span><span class="nf">(jwt_req) -&gt;</span>
    <span class="nv">jwt_header  = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">header</span>
    <span class="nv">jwt_claim   = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">claim</span>
    <span class="nv">jwt_enc_sig = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">segments</span><span class="o">?</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">jwt_header</span><span class="p">.</span><span class="nx">alg</span> <span class="o">==</span> <span class="s">&quot;none&quot;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span>     <span class="nx">jwt_enc_sig</span>
    <span class="kc">true</span>

<span class="nv">newNoneVerifier = </span><span class="nf">() -&gt;</span> <span class="k">new</span> <span class="nx">NoneVerifier</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Provides the HMAC implementation of the <strong>HS256</strong>, <strong>HS384</strong> and <strong>HS512</strong> algorithms.
Cryptographic algorithms are provided by <strong>Node's</strong> <a href="http://nodejs.org/api/crypto.html">Crypto library</a></p>

<p>As mentioned in the specification the HMAC (Hash-based Message Authentication Codes) enable the usage
of a <em>known secret</em>, this can be used to demonstrate that the MAC matches the hashed content, 
in this case the JWS Secured Input, which therefore demonstrates that whoever generated the MAC was in
possession of the secret. </p>

<p>To review the specifics of the algorithms please review chapter
"3.2.  MAC with HMAC SHA-256, HMAC SHA-384, or HMAC SHA-512" of
the <a href="https://www.ietf.org/id/draft-ietf-jose-json-web-algorithms-02.txt">Specification</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">HMACSigner</span> <span class="k">extends</span> <span class="nx">JwaAlgorithm</span>

  <span class="nv">alg : </span><span class="s">&quot;HMAC&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Creates and returns an HMAC object, a cryptographic HMAC binded to the given algorithm and key.
The supported algorithm is dependent on the available algorithms in <em>OpenSSL</em> - to get the list
type <code>openssl list-message-digest-algorithms</code> in the terminal. If you provide an algorithm that is
not supported an error will be thrown.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(alg = &quot;HS256&quot; , @key) -&gt;</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;A defined algorithm is required.&quot;</span> <span class="nx">unless</span> <span class="nx">alg</span>

    <span class="vi">@osslAlg = </span><span class="nx">@hash</span><span class="p">(</span><span class="nx">alg</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">())</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;Algorithm </span><span class="si">#{</span><span class="nx">@alg</span><span class="si">}</span><span class="s"> is not supported by HMAC.&quot;</span> <span class="nx">unless</span> <span class="nx">@osslAlg</span>

    <span class="k">try</span>
      <span class="vi">@hmac = </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHmac</span> <span class="nx">@osslAlg</span><span class="p">,</span> <span class="nx">@key</span>
    <span class="k">catch</span> <span class="nx">error</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;HMAC does not support algorithm </span><span class="si">#{</span><span class="nx">@alg</span><span class="si">}</span><span class="s"> =&gt; </span><span class="si">#{</span><span class="nx">@osslAlg</span><span class="si">}</span><span class="s">! </span><span class="si">#{</span><span class="nx">error</span><span class="si">}</span><span class="s">&quot;</span>

  <span class="nv">update: </span><span class="nf">(data) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;There is no reference to the hmac object!&quot;</span> <span class="nx">unless</span> <span class="nx">@hmac</span>
    <span class="nx">@hmac</span><span class="p">.</span><span class="nx">update</span> <span class="nx">data</span>
    <span class="nx">@</span>

  <span class="nv">digest: </span><span class="nf">(encoding = &quot;base64&quot;) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;There is no reference to the hmac object!&quot;</span> <span class="nx">unless</span> <span class="nx">@hmac</span>
    <span class="nx">ju</span><span class="p">.</span><span class="nx">base64urlEscape</span><span class="p">(</span> <span class="nx">@hmac</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="nx">encoding</span><span class="p">)</span> <span class="p">)</span>

  <span class="nv">sign: </span><span class="nf">(encoding) -&gt;</span> <span class="nx">@digest</span><span class="p">(</span><span class="nx">encoding</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Factory to create <em>HMAC Algorithm</em> instances</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">newHMACSigner = </span><span class="nf">(alg, key) -&gt;</span>
  <span class="k">new</span> <span class="nx">HMACSigner</span><span class="p">(</span><span class="nx">alg</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Todo: Move to JWS</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">HMACVerifier</span> <span class="k">extends</span> <span class="nx">JwaAlgorithm</span>

  <span class="nv">alg: </span><span class="s">&quot;HMAC&quot;</span>

  <span class="nv">verify: </span><span class="nf">(jwt_req, key) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;jwt request not specified&quot;</span> <span class="nx">unless</span> <span class="nx">jwt_req</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;key not specified&quot;</span> <span class="nx">unless</span> <span class="nx">key</span>

    <span class="nv">_typ     = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">header</span><span class="o">?</span><span class="p">.</span><span class="nx">typ</span>
    <span class="nv">_alg     = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">header</span><span class="o">?</span><span class="p">.</span><span class="nx">alg</span>
    <span class="nv">_claim   = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">claim</span>
    <span class="nv">_enc_sig = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">segments</span><span class="o">?</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>is the header a jwt header?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">_typ</span> <span class="o">==</span> <span class="s">&quot;JWT&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>is the algorithm supported/available for hmac ?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Hash </span><span class="si">#{</span><span class="nx">_alg</span><span class="si">}</span><span class="s"> is not supported!&quot;</span> <span class="nx">unless</span> <span class="nx">@hash</span><span class="p">(</span> <span class="nx">_alg</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>do we have an encoded signature?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">_enc_sig</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>do we have the implementation of such hmac algorithm?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">algImpl = </span><span class="nx">jwa_provider</span><span class="p">(</span><span class="nx">_alg</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">algImpl</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>set the signer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">signer = </span><span class="nx">algImpl</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>if so we proceed to sign the segments that belong to the header and the claim</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">signer</span><span class="p">.</span><span class="nx">update</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">jwt_req</span><span class="p">.</span><span class="nx">segments</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">jwt_req</span><span class="p">.</span><span class="nx">segments</span><span class="o">?</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>get signed value form the JWT</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_actual_sign = </span><span class="nx">signer</span><span class="p">.</span><span class="nx">sign</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>compare</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_actual_sign</span> <span class="o">==</span> <span class="nx">_enc_sig</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Todo: Move to JWS</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">newHMACVerifier = </span><span class="nf">() -&gt;</span> <span class="k">new</span> <span class="nx">HMACVerifier</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Implementation of digital signature with RSA SHA-256, RSA SHA-384, or RSA SHA-512</p>

<p>To review the specifics of the algorithms please review chapter
 "3.3.  Digital Signature with RSA SHA-256, RSA SHA-384, or RSA SHA-512" of
 the <a href="https://www.ietf.org/id/draft-ietf-jose-json-web-algorithms-02.txt">Specification</a>.</p>

<p>Important elements to understand are.
 * RSASSA-PKCS1-v1_5 digital signature algorithm (commonly known as PKCS#1), 
 using SHA-256, SHA-384, or SHA-512 as the hash function. </p>

<p>The <em>"alg"</em> (algorithm) header parameter values used in the JWS Header to indicate that 
 the <em>Encoded JWS Signature</em> contains a <strong>base64url</strong> encoded <em>*RSA digital signature</em> using the
 respective hash function are:
 * "RS256"
 * "RS384"
 * "RS512" </p>

<p><strong>A key of size 2048 bits or larger MUST be used with these algorithms.</strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">RSSigner</span> <span class="k">extends</span> <span class="nx">JwaAlgorithm</span>

  <span class="nv">alg : </span><span class="s">&quot;RSA&quot;</span>

  <span class="nv">_assertSigner : </span><span class="nf">() -&gt;</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;Signer is not defined!&quot;</span> <span class="nx">unless</span> <span class="nx">@signer</span>

  <span class="nv">constructor: </span><span class="nf">(alg = &quot;RSA-SHA256&quot;, @key_PEM) -&gt;</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;A defined algorithm is required.&quot;</span> <span class="nx">unless</span> <span class="nx">alg</span>
    
    <span class="vi">@osslAlg = </span><span class="nx">@hash</span><span class="p">(</span> <span class="nx">alg</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Algorithm </span><span class="si">#{</span><span class="nx">alg</span><span class="si">}</span><span class="s"> is not supported by the specification.&quot;</span> <span class="nx">unless</span> <span class="nx">@osslAlg</span>

    <span class="k">try</span>
      <span class="vi">@signer = </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createSign</span><span class="p">(</span><span class="nx">@osslAlg</span><span class="p">)</span>
    <span class="k">catch</span> <span class="nx">error</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unable to create a signer with algorithm </span><span class="si">#{</span><span class="nx">@osslAlg</span><span class="si">}</span><span class="s">!&quot;</span>
  
  <span class="nv">update: </span><span class="nf">(data) -&gt;</span>
    <span class="nx">@_assertSigner</span><span class="p">()</span>
    <span class="nx">@signer</span><span class="p">.</span><span class="nx">update</span> <span class="nx">data</span>
    <span class="nx">@</span>

  <span class="nv">sign: </span><span class="nf">(format = &quot;base64&quot;) -&gt;</span>
    <span class="nx">@_assertSigner</span><span class="p">()</span>
    <span class="nv">_signed = </span><span class="nx">@signer</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">@key_PEM</span><span class="p">,</span> <span class="nx">format</span><span class="p">)</span>
    <span class="nv">_enc_sign = </span><span class="nx">ju</span><span class="p">.</span><span class="nx">base64urlEscape</span> <span class="nx">_signed</span>
    <span class="nx">_enc_sign</span>

<span class="nv">newRSSigner = </span><span class="nf">(alg, key_PEM) -&gt;</span> <span class="k">new</span> <span class="nx">RSSigner</span><span class="p">(</span> <span class="nx">alg</span><span class="p">,</span> <span class="nx">key_PEM</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>TODO move verifier to JWS</p>

<p>Implementation of verification of a RSA SHA-256, RSA SHA-384, or RSA SHA-512 signature.</p>

<p>To review the specifics of the algorithms please review chapter
 "3.3.  Digital Signature with RSA SHA-256, RSA SHA-384, or RSA SHA-512" of
 the <a href="https://www.ietf.org/id/draft-ietf-jose-json-web-algorithms-02.txt">Specification</a>.</p>

<p>The <em>Encoded JWS Signature</em> contains a <strong>base64url</strong> encoded <em>*RSA digital signature</em>. The
 following hash functions are available.</p>

<p>Per specification the validation should be implemented as follows:</p>

<p>o.  Take the Encoded JWS Signature and base64url decode it into a
      byte array.  If decoding fails, the JWS MUST be rejected.</p>

<ol>
<li><p>Submit the bytes of the UTF-8 representation of the JWS Secured
  Input (which is the same as the ASCII representation) and the
  public key corresponding to the private key used by the signer to
  the RSASSA-PKCS1-V1_5-VERIFY algorithm using the corresponding SHA hash function (e.g. SHA-256).</p></li>
<li><p>If the validation fails, the JWS MUST be rejected.</p></li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">RSVerifier</span> <span class="k">extends</span> <span class="nx">JwaAlgorithm</span>

  <span class="nv">alg : </span><span class="s">&quot;RSA&quot;</span>
  
  <span class="nv">_createVerifier = </span><span class="nf">(alg) -&gt;</span>
    <span class="k">try</span>
      <span class="nx">crypto</span><span class="p">.</span><span class="nx">createVerify</span><span class="p">(</span><span class="nx">alg</span><span class="p">)</span>
    <span class="k">catch</span> <span class="nx">error</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unable to create a verifier with algorithm </span><span class="si">#{</span><span class="nx">alg</span><span class="si">}</span><span class="s">! </span><span class="si">#{</span><span class="nx">error</span><span class="si">}</span><span class="s">&quot;</span>
  
  <span class="nv">verify: </span><span class="nf">(jwt_req, public_key) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;jwt request not specified&quot;</span> <span class="nx">unless</span> <span class="nx">jwt_req</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;public_key not specified&quot;</span> <span class="nx">unless</span> <span class="nx">public_key</span>

    <span class="nv">_typ     = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">header</span><span class="o">?</span><span class="p">.</span><span class="nx">typ</span>
    <span class="nv">_alg     = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">header</span><span class="o">?</span><span class="p">.</span><span class="nx">alg</span>
    <span class="nv">_claim   = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">claim</span>
    <span class="nv">_enc_sig = </span><span class="nx">jwt_req</span><span class="o">?</span><span class="p">.</span><span class="nx">segments</span><span class="o">?</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>is the header a jwt header?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">_typ</span> <span class="o">==</span> <span class="s">&quot;JWT&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>do we have an encoded signature?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">_enc_sig</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>is the algorithm supported/available for RSA ?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">openSSL = </span><span class="nx">@hash</span><span class="p">(</span><span class="nx">_alg</span><span class="p">)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Hash </span><span class="si">#{</span><span class="nx">_alg</span><span class="si">}</span><span class="s"> is not supported for this JWA </span><span class="si">#{</span><span class="nx">@type</span><span class="si">}</span><span class="s">&quot;</span> <span class="nx">unless</span> <span class="nx">openSSL</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>can we create a verifier for the implementation of such algorithm?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_verifier = </span><span class="nx">_createVerifier</span> <span class="nx">openSSL</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">_verifier</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>update the verifier with the that used to generate the key</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_verifier</span><span class="p">.</span><span class="nx">update</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">jwt_req</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">jwt_req</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>we un-encode the encoded signature</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_sig = </span><span class="nx">ju</span><span class="p">.</span><span class="nx">base64urlUnescape</span> <span class="nx">_enc_sig</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>finally we verify</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_verifier</span><span class="p">.</span><span class="nx">verify</span> <span class="nx">public_key</span><span class="p">,</span> <span class="nx">_sig</span><span class="p">,</span> <span class="s">&quot;base64&quot;</span>

<span class="nv">newRSVerifier = </span><span class="nf">() -&gt;</span> <span class="k">new</span> <span class="nx">RSVerifier</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>TODO: Implement 
      3.4.  Digital Signature with ECDSA P-256 SHA-256, ECDSA P-384 SHA-384,
            or ECDSA P-521 SHA-512</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Returns a function that holds an <em>Encryption Algorithm</em>, or <code>undefined</code> if the algorithm is not supported or not found. </p>

<p>+--------------------+----------------------------------------------+
  | alg Parameter      | Digital Signature or MAC Algorithm           |
  | Value              |                                              |
  +--------------------+----------------------------------------------+
  | HS256              | HMAC using SHA-256 hash algorithm            |
  | HS384              | HMAC using SHA-384 hash algorithm            |
  | HS512              | HMAC using SHA-512 hash algorithm            |
  | RS256              | RSA using SHA-256 hash algorithm             |
  | RS384              | RSA using SHA-384 hash algorithm             |
  | RS512              | RSA using SHA-512 hash algorithm             |
  | ES256              | ECDSA using P-256 curve and SHA-256 hash     |
  |                    | algorithm                                    |
  | ES384              | ECDSA using P-384 curve and SHA-384 hash     |
  |                    | algorithm                                    |
  | ES512              | ECDSA using P-521 curve and SHA-512 hash     |
  |                    | algorithm                                    |
  | none               | No digital signature or MAC value included   |
  +--------------------+----------------------------------------------+</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports.provider = jwa_provider = </span><span class="nf">(code) -&gt;</span>
  <span class="k">switch</span> <span class="nx">code</span>
    <span class="k">when</span> <span class="s">&quot;none&quot;</span> <span class="k">then</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">newNoneSigner</span><span class="p">()</span>
    
    <span class="k">when</span> <span class="s">&quot;HS256&quot;</span><span class="p">,</span> <span class="s">&quot;HS384&quot;</span><span class="p">,</span> <span class="s">&quot;HS512&quot;</span> <span class="k">then</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">newHMACSigner</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">key</span>
    
    <span class="k">when</span> <span class="s">&quot;RS256&quot;</span><span class="p">,</span> <span class="s">&quot;RS384&quot;</span><span class="p">,</span> <span class="s">&quot;RS512&quot;</span> <span class="k">then</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">newRSSigner</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">key</span>
    
    <span class="k">when</span> <span class="s">&quot;ES256&quot;</span><span class="p">,</span> <span class="s">&quot;ES384&quot;</span><span class="p">,</span> <span class="s">&quot;ES512&quot;</span> <span class="k">then</span> <span class="kc">undefined</span> <span class="c1">#throw new Error &quot;ECDSA not yet implemented.&quot;</span>

    <span class="k">else</span> <span class="kc">undefined</span> <span class="c1">#throw new Error &quot;There is no JWA Provider for #{code}!&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Provides</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports.verifier = jwa_verifier = </span><span class="nf">(code) -&gt;</span>
  <span class="k">switch</span> <span class="nx">code</span>
    <span class="k">when</span> <span class="s">&quot;none&quot;</span> <span class="k">then</span> <span class="nx">newNoneVerifier</span><span class="p">()</span>
    
    <span class="k">when</span> <span class="s">&quot;HS256&quot;</span><span class="p">,</span> <span class="s">&quot;HS384&quot;</span><span class="p">,</span> <span class="s">&quot;HS512&quot;</span> <span class="k">then</span> <span class="nx">newHMACVerifier</span><span class="p">()</span>
    
    <span class="k">when</span> <span class="s">&quot;RS256&quot;</span><span class="p">,</span> <span class="s">&quot;RS384&quot;</span><span class="p">,</span> <span class="s">&quot;RS512&quot;</span> <span class="k">then</span> <span class="nx">newRSVerifier</span><span class="p">()</span>
    
    <span class="k">when</span> <span class="s">&quot;ES256&quot;</span><span class="p">,</span> <span class="s">&quot;ES384&quot;</span><span class="p">,</span> <span class="s">&quot;ES512&quot;</span> <span class="k">then</span> <span class="kc">undefined</span> <span class="c1">#throw new Error &quot;ECDSA not yet implemented.&quot;</span>

    <span class="k">else</span> <span class="kc">undefined</span> <span class="c1">#throw new Error &quot;There is no JWA Provider for #{code}!&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 