<!DOCTYPE html>  <html> <head>   <title>jwt.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="jot.html">                 jot.coffee               </a>                                           <a class="source" href="jwa.html">                 jwa.coffee               </a>                                           <a class="source" href="jwk.html">                 jwk.coffee               </a>                                           <a class="source" href="jwt.html">                 jwt.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               jwt.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Node</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">crypto  = </span><span class="nx">require</span> <span class="s">&quot;crypto&quot;</span>
<span class="nv">qstring = </span><span class="nx">require</span> <span class="s">&quot;querystring&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Lib</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">jwa = </span><span class="nx">require</span> <span class="s">&quot;./jwa&quot;</span>
<span class="nv">ju  = </span><span class="nx">require</span> <span class="s">&quot;./utils&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>version of the specification we are based on. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports.spec_version = </span><span class="s">&quot;draft-jones-json-web-token-10&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Decodes a given JWT Token.</p>

<h2>Arguments</h2>

<ul>
<li>token : The encoded JWT.</li>
</ul>

<h2>Returns</h2>

<ul>
<li>A <strong>JWT Request</strong> that holds the following.
<ul><li>Attributes: header, claim, segments.</li>
<li>Methods: verify( key ) where they key is <em>alogrithm</em> dependant. e.g. if RS you should use a valid <em>public PEM</em></li></ul></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports.decode = </span><span class="nf">(token) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>check segments</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">segments = </span><span class="nx">token</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;.&#39;</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;Not enough or too many segments&#39;</span> <span class="k">if</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">3</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>All segment should be base64</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">headerSeg     = </span><span class="nx">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">payloadSeg    = </span><span class="nx">segments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nv">signatureSeg  = </span><span class="nx">segments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>base64 decode and parse JSON</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">header    = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">ju</span><span class="p">.</span><span class="nx">base64urlDecode</span><span class="p">(</span><span class="nx">headerSeg</span><span class="p">)</span>
  <span class="nv">claim     = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">ju</span><span class="p">.</span><span class="nx">base64urlDecode</span><span class="p">(</span><span class="nx">payloadSeg</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>return</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">new</span> <span class="nx">JwtRequest</span><span class="p">(</span> <span class="nx">header</span><span class="p">,</span> <span class="nx">claim</span><span class="p">,</span> <span class="nx">segments</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Creates a <em>JWT Token</em> given the <em>claim</em>, the <em>key</em> and the given <em>algorithm</em>. The <em>algorithm</em> defaults to 
<code>"HS256"</code> (Which is a <em>JWS</em> <em>HMAC</em> signature).</p>

<h1>Rules for Creating a JWT</h1>

<p>To create a JWT, one MUST perform these steps.  The order of the
  steps is not significant in cases where there are no dependencies
  between the inputs and outputs of the steps.</p>

<ol>
<li><p>Create a JWT Claims Set containing the desired claims.  Note that
  white space is explicitly allowed in the representation and no
  canonicalization is performed before encoding.</p></li>
<li><p>Let the Message be the bytes of the UTF-8 representation of the JWT Claims Set.</p></li>
<li><p>Create a JWT Header containing the desired set of header
  parameters.  The JWT MUST conform to either the [JWS] or [JWE]
  specifications.  Note that white space is explicitly allowed in
  the representation and no canonicalization is performed before
  encoding.</p></li>
<li><p>Base64url encode the bytes of the UTF-8 representation of the JWT
  Header.  Let this be the Encoded JWT Header.</p></li>
<li><p>Depending upon whether the JWT is a JWS or JWE, there are two
  cases:</p>

<ul><li><p>If the JWT is a JWS, create a JWS using the JWT Header as the
 JWS Header and the Message as the JWS Payload; all steps
 specified in [JWS] for creating a JWS MUST be followed.</p></li>
<li><p>Else, if the JWT is a JWE, create a JWE using the JWT Header
 as the JWE Header and the Message as the JWE Plaintext; all
 steps specified in [JWE] for creating a JWE MUST be followed.</p></li></ul></li>
<li><p>If a nested signing or encryption operation will be performed,
  let the Message be the JWS or JWE, and return to Step 3, using a
  "typ" value of either "JWS" or "JWE" respectively in the new JWT
  Header created in that step.</p></li>
<li><p>Otherwise, let the resulting JWT be the JWS or JWE.</p></li>
</ol>

<p>Todo: Refactor to segregate the concerns between JWT and JWS.
Todo: Include basic support for JWE identification (regardless of having implemented the JWE algorithms).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports.encode = </span><span class="nf">(claim, key, algorithm = &quot;HS256&quot;) -&gt;</span>

  <span class="nv">jwa_provider  = </span><span class="nx">jwa</span><span class="p">.</span><span class="nx">provider</span> <span class="nx">algorithm</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Algorithm </span><span class="si">#{</span><span class="nx">algorithm</span><span class="si">}</span><span class="s"> is not yet supported.&quot;</span> <span class="nx">unless</span> <span class="nx">jwa_provider</span>

  <span class="nv">jwa_signer = </span><span class="nx">jwa_provider</span> <span class="nx">key</span>

  <span class="nv">header =</span>
    <span class="nv">typ: </span><span class="s">&#39;JWT&#39;</span>
    <span class="nv">alg: </span><span class="nx">algorithm</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>create segments, all segment should be base64 string</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">segments = </span><span class="p">[]</span>
  <span class="nx">segments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ju</span><span class="p">.</span><span class="nx">base64urlEncode</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">header</span><span class="p">))</span>
  <span class="nx">segments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ju</span><span class="p">.</span><span class="nx">base64urlEncode</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">claim</span><span class="p">))</span>

  <span class="nx">jwa_signer</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">join</span> <span class="s">&quot;.&quot;</span> <span class="p">)</span>
  <span class="nx">segments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">jwa_signer</span><span class="p">.</span><span class="nx">sign</span><span class="p">()</span> <span class="p">)</span>
  
  <span class="nx">segments</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Abstracts the handling of a JWT Request. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">JwtRequest</span>
  
  <span class="nv">constructor: </span><span class="nf">(@header, @claim, @segments) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unable to read `typ` form header or it doesn&#39;t match the expected &#39;JWT&#39; value &quot;</span> <span class="nx">unless</span> <span class="nx">@header</span><span class="p">.</span><span class="nx">typ</span> <span class="o">==</span> <span class="s">&#39;JWT&#39;</span>

  <span class="nv">verify: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">_alg = </span><span class="nx">@header</span><span class="o">?</span><span class="p">.</span><span class="nx">alg</span>
    <span class="nv">_alg = </span><span class="s">&quot;none&quot;</span> <span class="nx">unless</span> <span class="nx">_alg</span>

    <span class="nv">_verifier = </span><span class="nx">jwa</span><span class="p">.</span><span class="nx">verifier</span> <span class="nx">_alg</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unable to find a verifier for algorithm </span><span class="si">#{</span><span class="nx">_alg</span><span class="si">}</span><span class="s">&quot;</span> <span class="nx">unless</span> <span class="nx">_verifier</span>

    <span class="nx">_verifier</span><span class="p">.</span><span class="nx">verify</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">key</span>
  

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 